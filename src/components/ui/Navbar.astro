---
import { Image } from 'astro:assets'
import {profile} from '../../settings'
import { getCollection } from 'astro:content'
import { template } from '@/settings'

const isBlogPopulated = await getCollection('blog').then(collection => collection.length > 0)

const {fullName, title} = profile
// Use the uploaded professional profile picture for navbar
const profilePicture = '/images/profilepic2.png'

// Navigation items with icons
const navigationItems = [
	{ href: `${template.base}/`, label: 'Home', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
	{ href: `${template.base}/papers`, label: 'Publications', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
	{ href: `${template.base}/projects`, label: 'Projects', icon: 'M4 6a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V6z M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M10 6h4' },
	{ href: `${template.base}/talks`, label: 'Talks', icon: 'M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V1a1 1 0 011-1h2a1 1 0 011 1v18a1 1 0 01-1 1H3a1 1 0 01-1-1V1a1 1 0 011-1h2a1 1 0 011 1v3m0 0h8m-8 0H5a1 1 0 00-1 1v14a1 1 0 001 1h14a1 1 0 001-1V5a1 1 0 00-1-1h-2m-8 0V4' },
	...(isBlogPopulated ? [{ href: `${template.base}/blog/1`, label: 'Blog', icon: 'M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z' }] : []),
	{ href: `${template.base}/teaching`, label: 'Teaching', icon: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253' },
	{ href: `${template.base}/cv`, label: 'CV', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
	{ href: `${template.base}/contact`, label: 'Contact', icon: 'M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' }
]
---
<aside
	class='px-6 pt-6 h-screen w-[20rem] bg-gradient-to-b from-base-200 via-base-200/95 to-base-300/90 backdrop-blur-sm text-base-content flex flex-col relative overflow-hidden'
>
	<!-- Subtle animated background pattern -->
	<div class="absolute inset-0 bg-gradient-to-br from-primary/5 via-secondary/5 to-accent/5 animate-pulse"></div>
	
	<div class='flex flex-col my-4 h-full relative z-10'>
		<div class="flex-1 min-h-0 flex flex-col">
			<!-- Profile Section -->
			<div class='flex justify-center items-center flex-col mb-8'>
				<div class="group relative w-40 h-40">
					<!-- Solid ring with hacker aesthetic -->
					<div class="absolute inset-0 bg-teal-600 dark:bg-cyan-500 rounded-full p-1 transition-all duration-300 group-hover:scale-110">
						<div class="w-full h-full bg-base-200 rounded-full p-1">
							<img
								class='mask mask-circle w-full h-full object-cover transition-all duration-300 group-hover:scale-105'
								src={profilePicture}
								alt={`Profile picture of ${fullName}`}
							/>
						</div>
					</div>
					<!-- Glow effect -->
					<div class="absolute inset-0 bg-teal-600/30 dark:bg-cyan-500/30 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 blur-xl -z-10"></div>
				</div>
				<h1 class="text-xl font-bold mt-6 hidden lg:block name-title-text transition-all duration-300 hover:scale-105">
					<span id="navbar-cipher-name" data-final-text={fullName} class="inline-block font-mono">{fullName}</span>
				</h1>
			</div>

			<!-- Navigation Menu -->
			<div class='mx-2 h-full'>
				<ul class='space-y-3 menu menu-md h-full overflow-y-auto'>
					{navigationItems.map((item, index) => (
						<li>
							<a href={item.href} class={`group relative overflow-hidden rounded-xl bg-transparent p-3 text-base font-medium transition-all duration-300 hover:scale-105 hover:shadow-lg hover:bg-teal-600/10 dark:hover:bg-cyan-600/10 active:scale-95`}>
								<div class="flex items-center space-x-3 relative z-10">
                                    <svg class="w-5 h-5 transition-all duration-300 group-hover:scale-110 group-hover:text-teal-600 dark:group-hover:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={item.icon}></path>
									</svg>
									<span class="transition-all duration-300 group-hover:text-teal-600 dark:group-hover:text-cyan-400">{item.label}</span>
								</div>
								<!-- Active border indicator - solid color -->
								<div class="absolute left-0 top-0 h-full w-1 bg-teal-600 dark:bg-cyan-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-r"></div>
							</a>
						</li>
					))}
				</ul>
			</div>
		</div>
        
	</div>
</aside>

<script>
  // Cipher rotor animation for the navbar name
  function initNavbarCipherAnimation() {
    const cipherElement = document.getElementById('navbar-cipher-name');
    if (!cipherElement) return;
    
    const finalText = cipherElement.dataset.finalText || '';
    if (!finalText) return;
    
    // Character sets (letters only, matching case)
    const charsUpper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const charsLower = 'abcdefghijklmnopqrstuvwxyz';
    
    // Helper to get charset based on character case
    function getCharsForChar(char) {
      if (char === char.toUpperCase() && char !== char.toLowerCase()) {
        return charsUpper;
      }
      return charsLower;
    }
    
    // Animation settings
    const totalDuration = 2500; // Total animation time in ms
    const frameRate = 50; // ms between each frame
    const frames = totalDuration / frameRate;
    
    // Track which characters are "locked"
    const locked = new Array(finalText.length).fill(false);
    let currentText = new Array(finalText.length).fill('');
    
    // Initialize with random characters (preserve spaces, match case)
    for (let i = 0; i < finalText.length; i++) {
      if (finalText[i] === ' ') {
        currentText[i] = ' ';
        locked[i] = true;
      } else {
        const chars = getCharsForChar(finalText[i]);
        currentText[i] = chars[Math.floor(Math.random() * chars.length)];
      }
    }
    
    cipherElement.textContent = currentText.join('');
    
    let frame = 0;
    
    const animate = () => {
      frame++;
      
      // Calculate how many characters should be locked by now
      const progress = frame / frames;
      const charsToLock = Math.floor(progress * finalText.length);
      
      for (let i = 0; i < finalText.length; i++) {
        if (locked[i]) continue;
        
        // Lock this character if it's time
        if (i < charsToLock) {
          currentText[i] = finalText[i];
          locked[i] = true;
        } else {
          // Keep cycling through random characters (matching case)
          if (Math.random() > 0.3) {
            const chars = getCharsForChar(finalText[i]);
            currentText[i] = chars[Math.floor(Math.random() * chars.length)];
          }
        }
      }
      
      cipherElement.textContent = currentText.join('');
      
      // Continue animation or finish
      if (frame < frames) {
        setTimeout(animate, frameRate);
      } else {
        // Ensure final text is correct
        cipherElement.textContent = finalText;
        // Remove mono font after animation completes
        cipherElement.classList.remove('font-mono');
      }
    };
    
    // Start animation after a brief delay
    setTimeout(animate, 200);
  }
  
  // Run animation - handle various loading scenarios for mobile compatibility
  function runAnimation() {
    setTimeout(initNavbarCipherAnimation, 50);
  }
  
  // Try multiple approaches for mobile compatibility
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', runAnimation);
  } else {
    // DOM already loaded
    runAnimation();
  }
  
  // Also run on Astro page transitions (for SPA navigation)
  document.addEventListener('astro:page-load', runAnimation);
</script>