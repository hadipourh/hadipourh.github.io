---
import Layout from '../layouts/Layout.astro'
import { profile, social, template } from '@/settings'
import Hero from '@/components/ui/Hero.astro'
import Grid from '@/components/ui/Grid.astro'
import ArticleList from '@/components/ui/ArticleList.astro'
import SecurityInfo from '@/components/ui/SecurityInfo.astro'

// Import publications from the auto-generated JSON file (same source as CV page)
import publicationsData from '../data/publications.json'

const { fullName, title, institute, research_areas } = profile

// Convert publications from JSON data to expected format for ArticleList
// Sort by year (most recent first) for "Recent Publications"
const publications = (publicationsData.publications as any[])
	.sort((a: any, b: any) => b.year - a.year)
	.map((pub: any) => ({
		title: pub.title,
		authors: pub.authors,
		journal: pub.venue,  // Use venue as journal
		time: pub.year.toString(),  // Convert year to string
		link: pub.url,  // Use url as link
		abstract: pub.abstract
	}))

// Use the uploaded professional profile picture
const profilePicture = '/images/profilepic1.png'

// Structured data: Person JSON-LD (invisible, SEO only)
const sameAsLinks = Object.values(social).filter((v) => typeof v === 'string' && v.startsWith('http')) as string[]
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Person",
  "name": fullName,
  "jobTitle": title,
  "affiliation": institute,
  "url": template.website_url || 'https://hadipourh.github.io',
  "image": (template.website_url || 'https://hadipourh.github.io') + profilePicture,
  "sameAs": sameAsLinks
}
---

<Layout>
	<div data-page="home" class="relative">
	
	<!-- Hero Section -->
	<section class='flex flex-col lg:flex-row items-center gap-6 lg:gap-12 border-b pb-8 lg:pb-12 relative'>
		<Hero
			fullName={fullName}
			title={title}
			institute={institute}
			profilePicture={profilePicture}
		/>
	</section>

	<!-- Interactive Terminal Section -->
	<section class='py-8 lg:py-12 border-b relative'>
		<div class='w-full max-w-6xl mx-auto'>
			<h2 class='text-2xl lg:text-3xl font-bold mb-6 lg:mb-8 text-cyan-600 dark:text-cyan-400'>Quick Message Terminal</h2>
			<p class='text-base lg:text-lg text-base-content/70 mb-4 lg:mb-6'>
				Send me a direct message through this terminal interface! Messages are delivered directly to my Telegram.
			</p>
			
			<div class='w-full group'>
				<div class='bg-gradient-to-br from-black to-gray-900 border-2 border-green-400 rounded-lg p-3 lg:p-6 font-mono text-xs lg:text-sm shadow-2xl shadow-green-400/30 hover:shadow-green-400/40 transition-shadow duration-300'>
					<!-- Terminal Header -->
					<div class='flex items-center justify-between mb-3 lg:mb-4 border-b border-green-400 pb-2'>
						<div class='flex items-center space-x-2'>
							<div class='w-2 h-2 lg:w-3 lg:h-3 bg-red-500 rounded-full animate-pulse'></div>
							<div class='w-2 h-2 lg:w-3 lg:h-3 bg-yellow-500 rounded-full animate-pulse' style="animation-delay: 0.5s"></div>
							<div class='w-2 h-2 lg:w-3 lg:h-3 bg-green-500 rounded-full animate-pulse' style="animation-delay: 1s"></div>
						</div>
						<span class='text-green-400 text-xs'>secure@crypt0grapher:~$</span>
					</div>

					<!-- Terminal Output - Full Width -->
					<div id='home-terminal-output' class='bg-gradient-to-br from-black to-gray-900 text-green-400 p-3 lg:p-4 rounded border border-green-400/50 h-48 lg:h-72 overflow-y-auto mb-4 font-mono text-xs lg:text-sm shadow-inner'>
						<!-- Messages will appear here with typing effect -->
					</div>

					<!-- Terminal Input -->
					<div class='flex flex-col sm:flex-row items-stretch sm:items-center gap-2'>
						<div class='flex items-center flex-1 min-w-0 bg-black/50 rounded p-2 border border-green-400/30'>
							<span class='text-green-400 text-xs lg:text-sm mr-2 flex-shrink-0'>root@secure:~#</span>
							<input
								id='home-terminal-input'
								name='home-terminal-input'
								type='text'
								placeholder='Enter your message here...'
								class='flex-1 bg-transparent border-none outline-none text-green-400 font-mono placeholder-green-600 text-xs lg:text-sm min-w-0'
							/>
						</div>
						<div class='flex gap-2 flex-shrink-0'>
							<button 
								id='home-terminal-send'
								class='px-2 sm:px-3 py-1 bg-gradient-to-r from-green-900 to-green-800 hover:from-green-700 hover:to-green-600 text-green-400 border border-green-400 rounded transition-all duration-200 font-mono text-xs shadow-lg hover:shadow-green-400/20'>
								[SEND]
							</button>
							<button 
								id='home-terminal-clear'
								class='px-2 sm:px-3 py-1 bg-gradient-to-r from-red-900 to-red-800 hover:from-red-700 hover:to-red-600 text-red-400 border border-red-400 rounded transition-all duration-200 font-mono text-xs shadow-lg hover:shadow-red-400/20'>
								[CLEAR]
							</button>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Import Security Info Component -->
			<div class="mt-6">
				<SecurityInfo />
			</div>
		</div>
	</section>

	<!-- Research Areas -->
	<section class='py-12 border-b relative'>
		<Grid gridTitle='Research Areas' gridItems={research_areas} />
	</section>

	<!-- Recent Publications -->
	<section class='py-12 border-t relative'>
		<ArticleList listTitle='Recent Publications' listItems={publications} />
	</section>
	</div>
</Layout>

<!-- Person JSON-LD (does not change UI) -->
<script type="application/ld+json" is:inline>
{JSON.stringify(jsonLd)}
</script>

<script>
import { initTerminal } from '../lib/terminal.js';

// Configure home page terminal
initTerminal({
  pageSelector: '[data-page="home"]',
  outputId: 'home-terminal-output',
  inputId: 'home-terminal-input',
  sendBtnId: 'home-terminal-send',
  clearBtnId: 'home-terminal-clear',
  source: 'home_terminal',
  storageKey: 'lastHomeMessageSent',
  alwaysRefresh: true // Always show fresh messages when navigating to this page
  // Using default welcome messages from terminal.js
});
</script>
