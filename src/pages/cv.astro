---
import Layout from '@/layouts/Layout.astro'
import { experiences, education, skills, teaching, presentations, reviews, honors, conferences, memberships, interests, languages } from '../data/cv'
import CvTimeline from '@/components/ui/CvTimeline.astro'
import IconRenderer from '@/components/ui/IconRenderer.astro'

import type { Experience, Education, Publication } from '../types/cv'
import List from '@/components/ui/List.astro'
import PublicationsList from '@/components/ui/PublicationsList.astro'

// Import publications from the auto-generated JSON file
import publicationsData from '../data/publications.json'

let orderdExperiences: Experience[] = []
let orderdEducations: Education[] = []
let orderedPublications: Publication[] = []

const orderElement = <T extends { time: string }>(a: T, b: T) => {
  const presentValues = ['present', 'now', 'current', 'today']
  if (
			presentValues.includes(
				(a['time'] as string)?.split(' - ')[1]?.toLowerCase()
			)
		) {
			// If the date is 'present', it should be the first element
			return -1
		}
		const dateA = new Date((a['time'] as string)?.split(' - ')[1])
		const dateB = new Date((b['time'] as string)?.split(' - ')[1])
		return dateB.getTime() - dateA.getTime()
}

if (experiences.length > 0) {
	orderdExperiences = experiences.sort((a, b) => {
		return orderElement(a, b)
	})
}

if (education.length > 0) {
	orderdEducations = education.sort((a, b) => {
		return orderElement(a, b)
	})
}

// Convert publications from JSON data to expected format with backward compatibility
const publications: Publication[] = (publicationsData.publications as any[]).map((pub: any) => ({
	...pub,
	journal: pub.venue,  // Alias for backward compatibility
	time: pub.year.toString(),  // Convert year to string for backward compatibility
	link: pub.url  // Alias for backward compatibility
}))

if (publications.length > 0) {
	orderedPublications = publications.sort((a: Publication, b: Publication) => {
		// Ensure time field exists for sorting
		const timeA = a.time || a.year?.toString() || '2024'
		const timeB = b.time || b.year?.toString() || '2024'
		return orderElement({ ...a, time: timeA }, { ...b, time: timeB })
	})
}
---

<Layout>
<div style="font-family: 'Quantico', sans-serif;">
	<!-- CV Header with Download Link -->
	<section class='mb-12'>
		<div class='flex justify-between items-center mb-8'>
			<h1 class='text-4xl font-bold'>Curriculum Vitae</h1>
			<a 
				href='/cv/CV.pdf' 
				download='Hosein_Hadipour_CV.pdf'
				class='btn btn-primary gap-2 whitespace-nowrap'
				target='_blank'
			>
				<svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
					<path fill-rule='evenodd' d='M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z' clip-rule='evenodd'></path>
				</svg>
				Download PDF
			</a>
		</div>
		<p class='text-lg text-gray-600'>
			Postdoctoral Researcher specializing in cryptanalysis of symmetric-key primitives and automated security analysis at Ruhr University Bochum.
		</p>
	</section>

	{
		orderdEducations.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Education
				</h2>
				<CvTimeline elements={orderdEducations} colored={true} />
			</section>
		)
	}

	{
		orderdExperiences.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Experiences
				</h2>
				<CvTimeline elements={orderdExperiences} colored={true} />
			</section>
		)
	}

	{
		skills.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Skills
				</h2>
				<div class='space-y-6'>
					{skills.reduce((acc: any[], skill) => {
						const existingCategory = acc.find(cat => cat.category === skill.category);
						if (existingCategory) {
							existingCategory.items.push(skill);
						} else {
							acc.push({ category: skill.category, items: [skill] });
						}
						return acc;
					}, []).map((categoryGroup, index) => {
						const hoverTints = ['hover:bg-teal-600/10', 'hover:bg-cyan-600/10', 'hover:bg-emerald-600/10'];
						const borderColors = ['border-teal-600/20 hover:border-teal-600/40', 'border-cyan-600/20 hover:border-cyan-600/40', 'border-emerald-600/20 hover:border-emerald-600/40'];
						const colorIndex = index % 3;
						return (
						<div class={`relative overflow-hidden p-5 rounded-lg bg-base-200 ${hoverTints[colorIndex]} transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 border ${borderColors[colorIndex]}`}>
							<div class='h-full'>
								<h3 class='font-bold text-lg mb-4 text-transparent bg-clip-text bg-clip-text text-teal-600 dark:text-cyan-400'>{categoryGroup.category}</h3>
								<div class='grid grid-cols-1 md:grid-cols-2 gap-3'>
									{categoryGroup.items.map((skill: any) => (
										<div class='bg-base-200/50 rounded p-3 hover:bg-base-200 transition-colors'>
											<h4 class='font-semibold text-sm mb-1 text-emerald-600 dark:text-emerald-400'>{skill.level}</h4>
											<p class='text-xs text-base-content/70'>{skill.skills}</p>
										</div>
									))}
								</div>
							</div>
						</div>
					)})}
				</div>
			</section>
		)
	}

	{
		teaching.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Teaching Experience
				</h2>
				<div class='space-y-4'>
					{teaching.map((item) => (
						<div class='border-l-2 border-primary pl-4'>
							<h3 class='text-lg font-semibold'>{item.course}</h3>
							<p class='text-primary font-medium'>{item.role} at {item.institution}</p>
							<p class='text-sm text-gray-600'>{item.time}</p>
							{item.description && <p class='text-sm mt-2'>{item.description}</p>}
						</div>
					))}
				</div>
			</section>
		)
	}

	{
		presentations.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Presentations & Visits
				</h2>
				<div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
					{presentations.map((item, index) => {
						const hoverTints = ['hover:bg-teal-600/10', 'hover:bg-cyan-600/10', 'hover:bg-emerald-600/10'];
						const borderColors = ['border-teal-600/20 hover:border-teal-600/40', 'border-cyan-600/20 hover:border-cyan-600/40', 'border-emerald-600/20 hover:border-emerald-600/40'];
						const colorIndex = index % 3;
						return (
						<div class={`relative overflow-hidden p-4 rounded-lg bg-base-200 ${hoverTints[colorIndex]} transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 border ${borderColors[colorIndex]}`}>
							<div class='h-full'>
								<div class='flex justify-between items-start mb-2'>
									{item.link ? (
										<a href={item.link} target='_blank' class='font-semibold hover:underline text-sm leading-tight text-emerald-600 dark:text-emerald-400'>
											{item.title}
										</a>
									) : (
										<h3 class='font-semibold text-sm leading-tight text-base-content'>{item.title}</h3>
									)}
									<span class='text-xs text-base-content/60 ml-2 flex-shrink-0'>{item.time}</span>
								</div>
								<p class='text-xs text-base-content/70 mb-1'>{item.location}</p>
								<p class='text-xs text-cyan-600 dark:text-cyan-400 mb-2'>{item.type}</p>
								{item.detailsLink && (
									<a href={item.detailsLink} target='_blank' class='text-xs text-blue-500 hover:underline inline-flex items-center gap-1'>
										ðŸ“Š Details
									</a>
								)}
							</div>
						</div>
					)})}
				</div>
			</section>
		)
	}

	{
		reviews.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Academic Reviews
				</h2>
				<div class='grid grid-cols-1 md:grid-cols-2 gap-3'>
					{reviews.map((item, index) => {
						const hoverTints = ['hover:bg-teal-600/10', 'hover:bg-cyan-600/10', 'hover:bg-emerald-600/10'];
						const borderColors = ['border-teal-600/20 hover:border-teal-600/40', 'border-cyan-600/20 hover:border-cyan-600/40', 'border-emerald-600/20 hover:border-emerald-600/40'];
						const colorIndex = index % 3;
						return (
						<div class={`flex justify-between items-center p-4 rounded-lg bg-base-200 ${hoverTints[colorIndex]} transition-all duration-300 shadow-lg hover:shadow-xl hover:scale-105 border ${borderColors[colorIndex]}`}>
								<span class='font-medium text-base-content'>{item.title}</span>
								<div class='text-right'>
									{item.link ? (
										<a href={item.link} target='_blank' class='text-sm text-emerald-600 dark:text-emerald-400 hover:underline'>
											{item.venue}
										</a>
									) : (
										<p class='text-sm text-emerald-600 dark:text-emerald-400'>{item.venue}</p>
									)}
									<p class='text-xs text-base-content/60'>{item.time}</p>
								</div>
							</div>
					)})}
				</div>
			</section>
		)
	}

	{
		honors.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Honors & Awards
				</h2>
				<div class='space-y-4'>
					{honors.map((item) => (
						<div class='border-l-2 border-secondary pl-4 flex items-start space-x-3'>
							<span class='text-2xl mt-1'>{item.icon}</span>
							<div class='flex-1'>
								{item.link ? (
									<a href={item.link} target='_blank' class='text-lg font-semibold text-secondary hover:underline'>
										{item.title}
									</a>
								) : (
									<h3 class='text-lg font-semibold text-secondary'>{item.title}</h3>
								)}
								<p class='text-sm text-gray-600'>{item.description}</p>
								<p class='text-xs text-gray-500'>{item.time}</p>
							</div>
						</div>
					))}
				</div>
			</section>
		)
	}

	{
		conferences.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Conference & Workshop Attendance
				</h2>
				<div class='space-y-3'>
					{conferences.map((item) => (
						<div class='flex justify-between items-start p-3 bg-base-100 border rounded'>
							<div>
								<h3 class='font-medium'>{item.title}</h3>
								<p class='text-sm text-gray-600'>{item.location}</p>
							</div>
							<div class='text-right'>
								<p class='text-sm text-primary font-medium'>{item.role}</p>
								<p class='text-sm text-gray-500'>{item.time}</p>
							</div>
						</div>
					))}
				</div>
			</section>
		)
	}

	{
		memberships.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Professional Memberships
				</h2>
				<div class='space-y-4'>
					{memberships.map((item) => (
						<div class='border-l-2 border-accent pl-4'>
							<h3 class='text-lg font-semibold'>{item.title}</h3>
							<p class='text-sm text-accent font-medium'>{item.time}</p>
							<p class='text-sm text-gray-600 mt-1'>{item.description}</p>
						</div>
					))}
				</div>
			</section>
		)
	}

	{
		interests.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Personal Interests
				</h2>
				<div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
					{interests.map((item) => (
						<div class='p-4 bg-base-200 rounded-lg'>
							<div class='flex items-center gap-2 mb-2'>
								<div class='text-primary'>
									<IconRenderer name={item.icon} size="md" />
								</div>
								<h3 class='font-semibold text-primary'>{item.title}</h3>
							</div>
							<p class='text-sm text-gray-600'>{item.description}</p>
						</div>
					))}
				</div>
			</section>
		)
	}

	{
		languages.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Languages
				</h2>
				<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4'>
					{languages.map((lang) => (
						<div class='p-4 bg-base-200 rounded-lg flex items-center space-x-3'>
							<div class='text-primary'>
								<IconRenderer name={lang.icon} size="md" />
							</div>
							<div class='flex-1'>
								<h3 class='font-semibold text-primary'>{lang.language}</h3>
								<p class='text-sm text-gray-600'>{lang.level}</p>
								<div class='flex items-center mt-1 space-x-1'>
									<div class={`w-4 h-2 rounded ${lang.proficiency >= 1 ? 'bg-green-500' : 'bg-gray-300'}`}></div>
									<div class={`w-4 h-2 rounded ${lang.proficiency >= 2 ? 'bg-blue-500' : 'bg-gray-300'}`}></div>
									<div class={`w-4 h-2 rounded ${lang.proficiency >= 3 ? 'bg-yellow-500' : 'bg-gray-300'}`}></div>
									<div class={`w-4 h-2 rounded ${lang.proficiency >= 4 ? 'bg-orange-500' : 'bg-gray-300'}`}></div>
									<div class={`w-4 h-2 rounded ${lang.proficiency >= 5 ? 'bg-red-500' : 'bg-gray-300'}`}></div>
								</div>
							</div>
						</div>
					))}
				</div>
			</section>
		)
	}

	</section>

	{
		orderedPublications.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 border-b pb-2'>
					Publications
				</h2>
				<PublicationsList elements={orderedPublications}/>
			</section>
		)
	}
</div>
</Layout>
